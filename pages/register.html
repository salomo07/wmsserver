<!doctype html>
<html lang="en" dir="ltr">

    <head>
        <meta charset="UTF-8">
        <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=0'>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="Sash â€“ Bootstrap 5  Admin & Dashboard Template">
        <meta name="author" content="Spruko Technologies Private Limited">
        <meta name="keywords" content="admin,admin dashboard,admin panel,admin template,bootstrap,clean,dashboard,flat,jquery,modern,responsive,premium admin templates,responsive admin,ui,ui kit.">

        <!-- FAVICON -->
        <link rel="shortcut icon" type="image/x-icon" href="../assets/images/brand/favicon.ico" />

        <!-- TITLE -->
        <title>{{.appname}}</title>

        <!-- BOOTSTRAP CSS -->
        <link id="style" href="../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

        <!-- STYLE CSS -->
        <link href="assets/css/style.css" rel="stylesheet" />
        <link href="../assets/css/dark-style.css" rel="stylesheet" />
        <link href="../assets/css/transparent-style.css" rel="stylesheet">
        <link href="../assets/css/skin-modes.css" rel="stylesheet" />

        <!--- FONT-ICONS CSS -->
        <link href="../assets/css/icons.css" rel="stylesheet" />

        <!-- COLOR SKIN CSS -->
        <link id="theme" rel="stylesheet" type="text/css" media="all" href="../assets/colors/color1.css" />

        <!-- INTERNAL SWITCHER CSS -->
        <link href="../assets/switcher/css/switcher.css" rel="stylesheet" />
        <link href="../assets/switcher/demo.css" rel="stylesheet" />
        <link href="../assets/css/smart_wizard_all.min.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="assets/css/toastr.css">
    </head>

    <body class="app sidebar-mini login-img ltr">

        <!-- BACKGROUND-IMAGE -->
        <div class="">

            <!-- GLOABAL LOADER -->
            <div id="global-loader">
                <img src="../assets/images/loader.svg" class="loader-img" alt="Loader">
            </div>
            <!-- /GLOABAL LOADER -->

            <!-- PAGE -->
            <div class="page">
                <div class="">
                    <!-- Theme-Layout -->

                    <!-- CONTAINER OPEN -->
                    <div class="col col-login mx-auto mt-7">
                        <div class="text-center">
                            <h2 class="dark-mode">{{.appname}}</h2>
                        </div>
                    </div>
                    <div class="container-login100">
                        <div class="wrap-login100 p-6">
                            <form id="formAccount" novalidate="novalidate">
                                <div id="smartwizard">
								    <div class="tab-content">
							        <div id="wizardRegistrasion">
                                        <h3><center>Account Information</center></h3>
                                        <section>
                                        	<div class="control-group form-group">
                                                <label class="form-label">Username :
                                                <span class="tx-danger">*</span></label>
                                                <input id="txtusername" name="txtusername" required="" type="text" class="form-control" placeholder="Username" minlength="4">
                                                <div class="invalid-feedback"></div>
                                            </div>
                                            <div class="control-group form-group">
                                                <label class="form-control-label">Email : <span class="tx-danger">*</span></label>
                                                <input id="txtemail" name="txtemail" required="" type="email" class="form-control" placeholder="Email">
                                            </div>	
                                            <div class="control-group form-group">
                                                <label class="form-control-label">Password : <span class="tx-danger">*</span></label>
                                                <input id="txtpass1" name="txtpass1" required="" type="password" class="form-control" placeholder="Password"minlength="5" >
                                            </div>	
                                            <div class="control-group form-group">
                                                <label class="form-control-label">Password : <span class="tx-danger">*</span></label>
                                                <input id="txtpass2" name="txtpass2" required="" type="password" class="form-control" placeholder="Re-type Password" minlength="5" data-v-equal="#txtpass1">
                                            </div>
                                            <div id="register">
			                                <label class="login-social-icon"><span>Or register with other account</span></label>
			                                <div class="d-flex justify-content-center">
											    <a id="customBtn">
			                                        <div class="social-login me-4 text-center" data-onsuccess="onSignIn">
			                                            <i class="fa fa-google"></i>
			                                        </div>
			                                    </a>
			                                    <a id="fbBtn" onclick="onClickFB()" href="javascript:void(0)">
			                                        <div class="social-login me-4 text-center">
			                                            <i class="fa fa-facebook"></i>
			                                        </div>
			                                    </a>
			                                </div>
                                        </section>
                                        <h3>Company</h3>
                                        <section>
                                            <p>Wonderful transition effects.</p>
                                            <div class="form-group wd-xs-300">
                                                <label class="form-control-label">Email: <span class="tx-danger">*</span></label> <input class="form-control"
                                                    id="email" name="email" placeholder="Enter email address" type="email" required="" autocomplete="new-password">
                                            </div>
                                        </section>
	                                </div>
								    </div>
								</div>
                            </form>
                        </div>
                    </div>
                    <!-- CONTAINER CLOSED -->
                </div>
            </div>
            <!-- END PAGE -->

        </div>
        <!-- BACKGROUND-IMAGE CLOSED -->

        
        <!-- JQUERY JS -->
        <script src="../assets/js/jquery.min.js"></script>

        <!-- BOOTSTRAP JS -->
        <script src="../assets/plugins/bootstrap/js/popper.min.js"></script>
        <script src="../assets/plugins/bootstrap/js/bootstrap.min.js"></script>

        <!-- PERFECT SCROLLBAR JS-->
        <script src="../assets/plugins/p-scroll/perfect-scrollbar.js"></script>

        <!-- THEME COLORS JS  -->
        <script src="../assets/js/themeColors.js"></script>

        <!-- CUSTOM JS -->
        <script src="../assets/js/custom.js"></script>
        <!-- SHOW PASSWORD JS -->
        <script src="../assets/js/show-password.min.js"></script>
        
        <!-- <script src="../assets/js/jquery.smartWizard.min.js"></script> -->
        <script src="../assets/js/jquery.steps.min.js"></script>
        <!-- <script src="../assets/js/jquery.validate.min.js"></script> -->
        <script src="../assets/js/just-validate.min.js"></script>
        <script src="../assets/js/jquery.accordion-wizard.min.js"></script>
        <script src="../assets/js/api_client.js"></script>
        <script src="../assets/js/toastr.min.js"></script>
    </body>

</html>
<script>
	const validation = new JustValidate('#formAccount', {
		errorFieldCssClass: 'is-invalid',
		focusInvalidField: true,
        lockForm: true,
        successFieldCssClass: 'is-valid',
        successLabelStyle: {
          fontSize: '14px',
          color: '#20b418',
        }
	});
	var errorAll={username:false,email:false,password:false};
	var form=$('#formAccount');
	var callGET=((url,callback)=>{
        var settings = {
          "url": url,
          "method": "GET",
          success:((result, textStatus, xhr)=>{
            callback(result)
          }),
          error:(result, textStatus, xhr)=>{
          	toastr.error(textStatus,"Error");
          }
        };
        $.ajax(settings)
	});
	var callPOST=((url,data,callback)=>{
        var settings = {
          "url": url,
          "method": "POST",
          "dataType":"json",
          "data": JSON.stringify(data),
          "success":((result, textStatus, xhr)=>{
            if(xhr.status!=200){toastr.error(textStatus,"Error");return}
            if(result==null){
              callback([])
            }else if (result!=null){
              callback(result)
            }
          }),
          error:(result, textStatus, xhr)=>{
            if(result.responseText='error'){toastr.error("Failed to load data...","Error");}
            if(xhr=="Unauthorized"){window.location.href = "/";}
            toastr.error(textStatus,"Error");
          }
        };
        $.ajax(settings)
      });
    var googleUser = {};
	var startApp = function() {
		gapi.load('auth2', function(){
		  auth2 = gapi.auth2.init({clientId: atob('{{.cid}}'),scope: 'email',plugin_name:'LoginHRIS'
		  });
		  attachSignin(document.getElementById('customBtn'));
		});
	};

	window.fbAsyncInit = function() {
	FB.init({appId:atob('{{.fid}}'),cookie: true,xfbml: false,version:'v2.7'});		
		FB.AppEvents.logPageView();   
	};

	(function(d, s, id){
	 var js, fjs = d.getElementsByTagName(s)[0];
	 if (d.getElementById(id)) {return;}
	 js = d.createElement(s); js.id = id;
	 js.src = "https://connect.facebook.net/en_US/sdk.js";
	 fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));

	function attachSignin(element) {
		auth2.attachClickHandler(element, {},
		    function(googleUser) {
		    	// console.log(googleUser.getBasicProfile().getEmail());
		    	$("#txtusername").val(googleUser.getBasicProfile().getName().split(" ").join(""));
				$("#txtemail").val(googleUser.getBasicProfile().getEmail());
				callPOST("/checkusername",{username:googleUser.getBasicProfile().getName().split(" ").join("")},(res)=>{
					if (res.length>0){
						toastr.warning("Username is already taken");
					}
				});
				$("#pass").focus();
				callPOST("/checkemail",{email:googleUser.getBasicProfile().getEmail().toLowerCase()},(res)=>{
					if (res.length>0){
						toastr.warning("Email is already registered, please sign-in with this email");
					}
				});
		    }, 
		    function(error) {
		      console.log(JSON.stringify(error, undefined, 2));
		      toastr.error(JSON.stringify(error, undefined, 2),"Error");
		    });
	}
	var onClickFB=()=>{
		errorAll.username=false;errorAll.email=false;
		validation.refresh();
		FB.login(function(response) {
			if (response.authResponse){
				callGET("https://graph.facebook.com/"+response.authResponse.userID+"?fields=email,name&access_token="+response.authResponse.accessToken,(rst)=>{
						$("#txtusername").val(rst.name.split(" ").join(""));
						$("#txtemail").val(rst.email);
						callPOST("/checkusername",{username:rst.name.split(" ").join("")},(res)=>{
							if (res.length>0){
								toastr.warning("Username is already taken");
								validation.showErrors({'#txtusername':'Username is already taken'});
								errorAll.username=true;
							}
						});
						$("#txtpass1").focus();
						callPOST("/checkemail",{email:rst.email.toLowerCase()},(res)=>{
							if (res.length>0){
								toastr.warning("Email is already registered, please sign-in with this email");
								validation.showErrors({'#txtemail':'Email is already taken'});
								errorAll.email=true;
								
							}
						});
					})
			}
		}, {scope: 'email'});
	}

	$('#wizardRegistrasion').steps({
        headerTag: 'h3',
        bodyTag: 'section',
        autoFocus: true,
        transitionEffect: "slideLeft",
        titleTemplate: '<span class="number">#index#<\/span> <span class="title">#title#<\/span>',
        onStepChanging: function(event, currentIndex, newIndex) {
            if (currentIndex < newIndex) {
                // Step 1 form validation
                if (currentIndex === 0) { 
                	console.log(checkForm1())
                	return false;
                	// validation.revalidate().then(isValid => {
                	// 	console.log(isValid)
                	// })
                	// if(validator.checkAll()==0)
                	// {return true;}
                	// else{return false;}   
                }
                // Step 2 form validation
                if (currentIndex === 1) {
                    if (email.isValid()) {
                        return true;
                    } else {
                        // email.validate();
                    }
                }
                // Always allow step back to the previous step even if the current step is not valid.
            } else {
                return true;
            }
        },
        onFinishing:(event, currentIndex)=>{
        	console.log("Finishing")
        }
    });

	
	var domHTML=this;
    var checkUsername=(ele,rst)=>{
    	if(errorAll.username==false && errorAll.email==false && errorAll.password==false)
    	{validation.refresh();}
    	errorAll.username=false;
    	if($(ele).val() !=""){
	    	callPOST("/checkusername",{username:$(ele).val()},(res)=>{
				if (res.length>0){
					toastr.warning("Username is already registered");
					validation.showErrors({ '#txtusername': 'Username is already registered' });
					errorAll.username=true;
				}
			});
		}
    }
    var checkEmail=(ele,rst)=>{
    	errorAll.email=false;
		if ($(ele).val()!=""){	
	    	return callPOST("/checkemail",{email:$(ele).val()},(res)=>{
				if (res.length>0){
					toastr.warning("Email is already registered");
					validation.showErrors({'#txtemail':'Email is already registered'});
					errorAll.email=true;
				}else{
					validation.showSuccessLabels({'#txtemail': 'The email looks good!',});
					// validation.showErrors({'#txtemail':''});
				}
			});
		}
    }

    $('#txtusername').on('input',(instance)=>{
    	checkUsername($('#txtusername'));
    })
    $('#txtemail').on('input',(instance)=>{
		checkEmail($('#txtemail'));
    })
	startApp();

	
	validation.addField('#txtusername', [
	{
	  rule: 'required',
	  errorMessage: 'Username is required'
	}]);
	validation.addField('#txtemail', [
	{
	  rule: 'required',
	  errorMessage: 'Email is required'
	},{
	  rule: 'email',
	  errorMessage: 'Email is not valid'
	}]);
	validation.addField('#txtpass1', [
	{
	  rule: 'required',
	  errorMessage: 'Field is required'
	}]);
	validation.addField('#txtpass2', [
	{
	  rule: 'required',
	  errorMessage: 'Field is required'
	}]);
	var checkForm1=()=>{
		var err=false;
		validation.revalidateField('#txtusername').then(isValid => {
			if(!isValid){
				validation.showErrors({'#txtusername':'Username is required'});
				return true;
			}
			if(errorAll.username==true){
				toastr.warning("Username is already taken");
				validation.showErrors({'#txtusername':'Username is already taken'});
				return true;
			}
		})
		validation.revalidateField('#txtemail').then(isValid => {
			if(!isValid){
				validation.showErrors({'#txtemail':'Email is required'});
				return true;
			}
			if(errorAll.email==true){
				toastr.warning("Email is already taken");
				validation.showErrors({'#txtemail':'Email is already taken'});
				return true;
			}
		})
		validation.revalidateField('#txtpass1').then(isValid => {
			if(!isValid){
				validation.showErrors({'#txtpass1':'Password is required'});
				return true;
			}
			if($('#txtpass1').val()!=$('#txtpass2').val()){
				validation.showErrors({'#txtpass1':'Password is not match'});
				return true;
			}
		})
		validation.revalidateField('#txtpass2').then(isValid => {
			if(!isValid){
				validation.showErrors({'#txtpass2':'Password is required'});
				return true;
			}
			if($('#txtpass1').val()!=$('#txtpass2').val()){
				validation.showErrors({'#txtpass2':'Password is not match'});
				return true;
			}
		})
		return err;
	}
</script>